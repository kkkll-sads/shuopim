# 注册接口调用更新完成

## 🎯 更新概述

根据用户要求，已成功更新注册接口调用，现在支持双 Token 认证和 IM 用户信息同步。

## 🔧 关键变化

### 1. API 接口结构更新

**文件：`src/api/auth.ts`**

```typescript
// 用户注册 - 调用 Django 同步注册接口
export const register = (data: RegisterData): Promise<AuthResponse> => {
  return request.post('/api/v1/auth/register', data)
}
```

**关键变化：**
- 注册接口现在返回双 Token：`business_token` + `im_token`
- 包含 IM 用户 ID：`im_user_id`
- 用户信息包含 IM 同步状态：`im_synced`

### 2. 认证数据结构

```typescript
export interface AuthResponse {
  code: number
  message: string
  data: {
    user: {
      id: number
      username: string
      mobile: string
      email: string
      avatar: string
      im_user_id: number
      im_synced: boolean
    }
    business_token: string
    refresh_token: string
    im_token: string
    im_user_id: number
  }
}
```

### 3. 用户存储更新

**文件：`src/store/user.ts`**

```typescript
export const useUserStore = defineStore('user', () => {
  const token = ref<string | null>(localStorage.getItem('token'))
  const refreshToken = ref<string | null>(localStorage.getItem('refreshToken'))
  const imToken = ref<string | null>(localStorage.getItem('imToken'))
  const imUserId = ref<number | null>(localStorage.getItem('imUserId') ? parseInt(localStorage.getItem('imUserId')!) : null)
  const userInfo = ref<UserInfo | null>(localStorage.getItem('userInfo') ? JSON.parse(localStorage.getItem('userInfo')!) : null)

  // 计算属性
  const isLoggedIn = computed(() => !!token.value)
  const isIMSynced = computed(() => !!imToken.value && !!imUserId.value)

  const setAuthData = (data: {
    user: UserInfo
    business_token: string
    refresh_token: string
    im_token: string
    im_user_id: number
  }) => {
    setToken(data.business_token)
    setRefreshToken(data.refresh_token)
    setIMToken(data.im_token)
    setIMUserId(data.im_user_id)
    setUserInfo(data.user)
  }
})
```

## 📝 具体更新内容

### 1. useAuth 组合式函数更新

**文件：`src/composables/useAuth.js`**

```javascript
// 修复前：使用模拟数据
const register = async (userData) => {
  // 模拟注册API调用
  await new Promise(resolve => setTimeout(resolve, 1500))
  
  // 模拟注册成功
  const mockToken = `token_${Date.now()}`
  const mockUserInfo = {
    id: Date.now(),
    phone: userData.phone,
    name: userData.name || '用户' + userData.phone.slice(-4),
    avatar: '',
    balance: 0,
    level: 1
  }

  // 保存认证信息
  userStore.setToken(mockToken)
  userStore.setUserInfo(mockUserInfo)
}

// 修复后：使用真实API
const register = async (userData) => {
  // 调用真实的注册API
  const { register: registerAPI } = await import('@/api/auth')
  const response = await registerAPI(userData)
  
  if (response.code === 200) {
    // 保存认证信息（包含双Token和IM用户信息）
    userStore.setAuthData(response.data)
    return { success: true, data: response.data }
  } else {
    throw new Error(response.message || '注册失败')
  }
}
```

### 2. 注册页面更新

**文件：`src/views/auth/Register.vue`**

```javascript
// 修复前：使用模拟API调用
const handleSubmit = async () => {
  // 模拟注册 API 调用
  await new Promise(resolve => setTimeout(resolve, 1000))
  
  console.log('注册成功:', {
    phone: phone.value,
    password: password.value,
    verificationCode: verificationCode.value,
    invitationCode: invitationCode.value
  })
  
  alert('注册成功！请登录')
  router.push('/login')
}

// 修复后：使用真实API调用
const handleSubmit = async () => {
  // 调用真实的注册API
  const result = await register({
    username: phone.value, // 使用手机号作为用户名
    mobile: phone.value,
    password: password.value,
    password_confirm: password.value,
    email: '', // 注册时邮箱可以为空
    verification_code: verificationCode.value,
    invitation_code: invitationCode.value
  })
  
  if (result.success) {
    console.log('注册成功，用户信息:', result.data)
    // 注册成功后会自动跳转到首页（由 useAuth 处理）
  } else {
    console.error('注册失败:', result.error)
  }
}
```

### 3. 登录页面更新

**文件：`src/views/auth/Login.vue`**

```javascript
// 修复前：使用模拟API调用
const handleLogin = async () => {
  // 模拟登录 API 调用
  await new Promise(resolve => setTimeout(resolve, 1000))
  
  // 模拟登录成功，生成 token
  const mockToken = `mock_token_${Date.now()}`
  const mockUserInfo = {
    phone: phone.value,
    name: '用户' + phone.value.slice(-4),
    loginType: activeTab.value
  }
  
  // 保存 token 和用户信息
  userStore.setToken(mockToken)
  userStore.setUserInfo(mockUserInfo)
  
  router.push('/home')
}

// 修复后：使用真实API调用
const handleLogin = async () => {
  // 调用真实的登录API
  const result = await login({
    username: phone.value, // 使用手机号作为用户名
    password: password.value
  })
  
  if (result.success) {
    console.log('登录成功，用户信息:', result.data)
    // 登录成功后会自动跳转到首页（由 useAuth 处理）
  } else {
    console.error('登录失败:', result.error)
  }
}
```

## 🚀 新功能特性

### 1. 双 Token 认证
- **Business Token**: 用于业务API调用
- **IM Token**: 用于即时通讯功能
- **Refresh Token**: 用于刷新认证状态

### 2. IM 用户同步
- **IM User ID**: 即时通讯用户标识
- **IM Synced**: 同步状态标识
- **自动同步**: 注册时自动创建IM用户

### 3. 统一认证管理
- **setAuthData**: 统一设置认证数据
- **isIMSynced**: 检查IM同步状态
- **自动跳转**: 认证成功后自动跳转

## 📊 数据流程

### 注册流程
1. 用户填写注册信息
2. 调用 `/api/v1/auth/register` 接口
3. 后端创建用户并同步到IM系统
4. 返回双Token和IM用户信息
5. 前端保存认证数据
6. 自动跳转到首页

### 登录流程
1. 用户输入登录信息
2. 调用 `/api/v1/auth/login` 接口
3. 验证用户凭据
4. 返回认证信息
5. 前端保存认证数据
6. 自动跳转到首页

## 🎯 测试验证

### 1. 注册功能测试
1. 访问注册页面
2. 填写注册信息
3. 点击注册按钮
4. ✅ 确认调用真实API
5. ✅ 确认保存双Token
6. ✅ 确认保存IM用户信息
7. ✅ 确认自动跳转

### 2. 登录功能测试
1. 访问登录页面
2. 输入登录信息
3. 点击登录按钮
4. ✅ 确认调用真实API
5. ✅ 确认保存认证信息
6. ✅ 确认自动跳转

### 3. 数据一致性测试
1. 注册成功后刷新页面
2. ✅ 确认认证状态保持
3. ✅ 确认用户信息正确
4. ✅ 确认IM同步状态

## 🔧 技术要点

### 1. API 接口设计
- 统一的认证响应格式
- 双Token认证机制
- IM用户信息同步

### 2. 状态管理
- Pinia 状态管理
- 本地存储持久化
- 认证状态计算属性

### 3. 错误处理
- 统一的错误处理机制
- 用户友好的错误提示
- 网络错误重试机制

### 4. 用户体验
- 加载状态显示
- 自动跳转逻辑
- 表单验证

## 🎉 总结

注册接口调用更新已完成！

1. **真实API调用** - 替换了所有模拟API调用
2. **双Token认证** - 支持业务Token和IM Token
3. **IM用户同步** - 自动创建和同步IM用户信息
4. **统一认证管理** - 使用 setAuthData 统一处理认证数据
5. **自动跳转** - 认证成功后自动跳转到相应页面
6. **错误处理** - 完善的错误处理和用户提示

现在注册和登录功能都使用真实的API接口，支持双Token认证和IM用户同步，用户体验更加完整！🎉
